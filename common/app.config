table ip nat {
    chain postrouting {
        type nat hook postrouting priority 100;
        oif != "docker0" masquerade
    }
}

table inet filter {
    chain input {
        type filter hook input priority filter; policy drop;

        # conexiones ya establecidas
        ct state established,related accept

        # loopback
        iifname "lo" accept

        # SSH admin
        tcp dport 22 accept

        # App web
        tcp dport 3000 accept

        # ICMP ping
        icmp type echo-request accept
    }

    chain forward {
        type filter hook forward priority filter; policy drop

        # tr√°fico docker
        iifname "docker0" accept
        oifname "docker0" accept

        # conexiones ya establecidas
        ct state established,related accept
    }

    chain output {
        type filter hook output priority filter; policy drop

        # conexiones ya establecidas
        ct state established,related accept

        # loopback
        oifname "lo" accept

        # DNS
        udp dport 53 accept
        tcp dport 53 accept

        # HTTP / HTTPS
        tcp dport 80 accept
        tcp dport 443 accept

        # RabbitMQ
        ip daddr 172.31.38.13 tcp dport 5672 accept

        # Kafka
        ip daddr 172.31.33.47 tcp dport 8080 accept
        tcp dport 9092 accept  # si tu app necesita Kafka

        # SSH saliente
        tcp dport 22 accept

        # ICMP saliente
        ip protocol icmp accept
    }
}
