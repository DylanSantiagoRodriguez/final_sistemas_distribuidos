# ================================
# Firewall para VM-ingest
# Compatible con Docker
# ================================

table inet filter {

    # -------------------------------
    # INPUT – Permite tráfico necesario
    # -------------------------------
    chain input {
        type filter hook input priority 0;
        policy drop;

        # Loopback
        iif "lo" accept;

        # Conexiones establecidas
        ct state established,related accept;

        # SSH (NO LO QUITES)
        tcp dport 22 accept;

        # Docker maneja sus propias reglas, permitimos tráfico interno docker0
        iifname "docker0" accept;
        iifname "br-" accept;

        # (Ingest normalmente NO recibe conexiones externas)
    }

    # -------------------------------
    # OUTPUT – Reglas importantes
    # -------------------------------
    chain output {
        type filter hook output priority 0;
        policy drop;

        # Conexiones establecidas
        ct state established,related accept;

        # Permitir salida hacia Kafka (vm-data)
        tcp dport 9092 ip daddr 172.31.6.99 accept;

        # Permitir salida hacia Auth Server
        tcp dport 443 ip daddr 172.31.35.24 accept;

        # Docker necesita salida libre para redes internas
        oifname "docker0" accept;
        oifname "br-" accept;

        # DNS (necesario para instalar paquetes, npm, etc.)
        udp dport 53 accept;
        tcp dport 53 accept;

        # HTTP/HTTPS necesarios para npm install, actualizaciones, etc.
        tcp dport 80 accept;
        tcp dport 443 accept;
    }

    # -------------------------------
    # FORWARD – Requerido por Docker
    # -------------------------------
    chain forward {
        type filter hook forward priority 0;
        policy accept;
    }
}
