---
- name: Create directories for Kafka and RabbitMQ
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  loop:
    - /opt/kafka/libs
    - /opt/kafka/config
    - /opt/rabbitmq/config

- name: Copy Kafka server.properties
  copy:
    src: server.properties
    dest: /opt/kafka/config/server.properties

- name: Download Strimzi OAuth server jar
  get_url:
    url: https://github.com/strimzi/strimzi-kafka-oauth/releases/download/0.12.0/strimzi-kafka-oauth-server-0.12.0.jar
    dest: /opt/kafka/libs/strimzi-kafka-oauth-server.jar

- name: Copy RabbitMQ configs
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: rabbitmq.conf, dest: /opt/rabbitmq/config/rabbitmq.conf }
    - { src: enabled_plugins, dest: /opt/rabbitmq/config/enabled_plugins }
    - { src: advanced.config, dest: /opt/rabbitmq/config/advanced.config }
    - { src: definitions.json, dest: /opt/rabbitmq/config/definitions.json }

- name: Run Zookeeper
  command: >
    docker run -d --restart unless-stopped --name zookeeper --network host
    -e ALLOW_ANONYMOUS_LOGIN=yes bitnami/zookeeper:3.8

- name: Run Kafka
  command: >
    docker run -d --restart unless-stopped --name kafka --network host
    -v /opt/kafka/libs:/opt/bitnami/kafka/libs
    -v /opt/kafka/config/server.properties:/opt/bitnami/kafka/config/server.properties
    -e KAFKA_CFG_ZOOKEEPER_CONNECT=127.0.0.1:2181
    -e KAFKA_CFG_LISTENERS=EXTERNAL://0.0.0.0:9092
    -e KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=EXTERNAL:SASL_PLAINTEXT
    -e KAFKA_CFG_SASL_ENABLED_MECHANISMS=OAUTHBEARER
    -e KAFKA_CFG_INTER_BROKER_LISTENER_NAME=EXTERNAL
    -e KAFKA_CFG_SASL_MECHANISM_INTER_BROKER_PROTOCOL=OAUTHBEARER
    -e KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
    -e KAFKA_CFG_LOG_DIRS=/bitnami/kafka/data
    bitnami/kafka:3.6

- name: Run RabbitMQ
  command: >
    docker run -d --restart unless-stopped --name rabbitmq --network host
    -v /opt/rabbitmq/config/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf
    -v /opt/rabbitmq/config/enabled_plugins:/etc/rabbitmq/enabled_plugins
    -v /opt/rabbitmq/config/advanced.config:/etc/rabbitmq/advanced.config
    -v /opt/rabbitmq/config/definitions.json:/etc/rabbitmq/definitions.json
    -e RABBITMQ_SERVER_ADDITIONAL_ERL_ARGS="-rabbitmq_management load_definitions \"/etc/rabbitmq/definitions.json\""
    rabbitmq:3.13-management
