---
- name: Copy auth_server sources
  synchronize:
    src: ../../services/auth_server/
    dest: /opt/auth_server/

- name: Generate self-signed certificate
  command: >
    openssl req -x509 -nodes -newkey rsa:2048
    -keyout /opt/auth_server/key.pem -out /opt/auth_server/cert.pem
    -subj "/CN=vm-auth" -days 365
  args:
    creates: /opt/auth_server/cert.pem

- name: Build auth_server image
  command: docker build -t smarttraffic/auth_server:latest /opt/auth_server

- name: Run auth_server container
  command: >
    docker run -d --restart unless-stopped --name auth_server
    -p 443:443
    -e JWT_SECRET=smarttraffic-secret
    -e TLS_CERT_PATH=/cert.pem -e TLS_KEY_PATH=/key.pem
    -v /opt/auth_server/cert.pem:/cert.pem:ro -v /opt/auth_server/key.pem:/key.pem:ro
    smarttraffic/auth_server:latest
  args:
    creates: /var/run/docker-auth-server
